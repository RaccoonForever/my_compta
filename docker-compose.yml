services:
  # ──────────────────────────────────────────
  # Firebase Emulators (Firestore, Auth, Pub/Sub, Hosting)
  # ──────────────────────────────────────────
  firebase:
    image: node:20-alpine
    working_dir: /app
    command: >
      sh -c "apk add --no-cache openjdk21-jre-headless &&
             npm install -g firebase-tools &&
             firebase emulators:start"
    ports:
      - "4000:4000"   # Emulator UI
      - "8080:8080"   # Firestore
      - "9099:9099"   # Auth
      - "8085:8085"   # Pub/Sub
    volumes:
      - ./infra/firebase:/app
    networks:
      - compta

  # ──────────────────────────────────────────
  # BFF – NestJS + Fastify (TypeScript)
  # ──────────────────────────────────────────
  bff:
    build:
      context: .
      dockerfile: apps/bff/Dockerfile.dev
    working_dir: /app
    command: >
      sh -c "corepack enable && pnpm install &&
             pnpm --filter @my-compta/domain build &&
             pnpm --filter @my-compta/bff dev"
    ports:
      - "4001:4001"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/bff/node_modules
    env_file:
      - apps/bff/.env.local
    environment:
      - NODE_ENV=development
      - FIRESTORE_EMULATOR_HOST=firebase:8080
      - FIREBASE_AUTH_EMULATOR_HOST=firebase:9099
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
    depends_on:
      - firebase
    networks:
      - compta

  # ──────────────────────────────────────────
  # Web – Next.js (TypeScript)
  # ──────────────────────────────────────────
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && pnpm --filter @my-compta/web dev"
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/web/node_modules
      - /app/apps/web/.next
    env_file:
      - apps/web/.env.local
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_BFF_URL=http://localhost:4001
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
      - WATCHPACK_POLLING=true
    depends_on:
      - bff
    networks:
      - compta

networks:
  compta:
    driver: bridge
